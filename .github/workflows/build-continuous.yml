name: Verification

on:
  pull_request:
    branches:
    - master

env:
  cache-version: v1

jobs:
  #==============================================================================
  Native-MSVC2017-x64-MT:
    runs-on: windows-2016 # for VS2017

    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 2.2.108

    - name: Cache (build/BuildCache)
      uses: actions/cache@v1.0.3
      with:
        path: ./build/MSVC2017-x64-MT/BuildCache
        key: ${{ env.cache-version }}-BuildCache-${{ hashFiles('**/BuildExternalProjects.cs') }}
        restore-keys: |
          ${{ env.cache-version }}-BuildCache-
            
    - name: Cache (build/MSVC2017-x64-MT/ExternalInstall)
      uses: actions/cache@v1.0.3
      with:
        path: ./build/MSVC2017-x64-MT/ExternalInstall
        key: ${{ env.cache-version }}-ExternalInstall-${{ hashFiles('**/BuildExternalProjects.cs') }}
        restore-keys: |
          ${{ env.cache-version }}-ExternalInstall-
            
    - name: Build
      run: dotnet run -- BuildEngine_MSVC MSVC2017-x64-MT
      
    - uses: actions/upload-artifact@v1
      with:
        name: LuminoEngine-MSVC2017-x64-MT
        path: ./build/MSVC2017-x64-MT/EngineInstall
  
  #==============================================================================
  Ruby:
    needs: Native-MSVC2017-x64-MT
    runs-on: windows-2016

    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Set up Ruby
      uses: actions/setup-ruby@v1
      with:
        ruby-version: 2.6.x
        architecture: 'x64'

    - uses: actions/download-artifact@v1
      with:
        name: LuminoEngine-MSVC2017-x64-MT
        path: ./build/MSVC2017-x64-MT/EngineInstall

    - name: Build and test with Rake
      run: dotnet run -- MakePackage_Ruby

